<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Seeneline</title>
    <style type="text/css" media="screen">
        #gamecanvas {
            background: url("images/ground.png")
        }
    </style>

    <script>
      var sources = {
        treeSprite: 'images/tree.png',
        heroSprite: 'images/hero.png',
        seenSprite: 'images/seen.png'
      }

      //      NB! The function is "onload" and not "onLoad"
      window.onload = function () {
        loadImages(sources, initGame)  // calls initGame after *all* images have finished loading
      }

      function loadImages (sources, callback) {
        var images = {}
        var loadedImages = 0
        var numOfImages = 0

        for (var src in sources) {
//          console.log("Img loaded: " + src);
          numOfImages++
        }

        for (var src in sources) {
          images[src] = new Image()
          images[src].onload = function () {
            if (++loadedImages >= numOfImages) {
//              Call initGame when all images loaded
              callback(images)
            }
          }
          images[src].src = sources[src]
        }

      }

      var seeni = 10  //kui palju on tarvis korjata
      var w, h, d0, h0, r, v, ctx, pFill, treeImage, hero, seen, collected, keysdown, then
      var startTime = Date.now() //seente korjamise aja leidmiseks

      function initGame (images) {

// Initialize the canvas
        var canvas = document.getElementById('gamecanvas')
        ctx = canvas.getContext('2d')
        w = canvas.width
        h = canvas.height
        //console.log('w,h '+w+h);
//Ground
        //pFill = ctx.createPattern(images.ground, "repeat");
        //ctx.fillStyle = pFill;
        //ctx.fillRect(0,0,w,h);
        //Trees
        treeImage = images.treeSprite
        d0 = treeImage.width //tree width
        h0 = treeImage.height
        v = Math.floor(w / d0)
        r = Math.floor(h / d0)

        hero = {
          sprite: images.heroSprite,
          x: Math.floor(w / 2),  //to center
          y: Math.floor(h / 2),
          speed: 2 // movement in pixels
        }

        seen = {
          sprite: images.seenSprite,
          x: images.seenSprite.width + (Math.random() * (w - 2 * images.seenSprite.width)),
          y: images.seenSprite.height + (Math.random() * (h - 2 * images.seenSprite.height))
        }

        collected = 0

// Handle keyboard controls
        keysDown = {}

        addEventListener('keydown', function (e) {
          e.preventDefault()
          keysDown[e.keyCode] = true
        }, false)

        addEventListener('keyup', function (e) {
          e.preventDefault()
          delete keysDown[e.keyCode]
        }, false)

// Reset the game when the player catches a mushroom

// Let's play this game!
        drawTrees()
//reset();
        then = Date.now()
        game()
//setTimeout(main,30);
      }

      function drawTrees () {

        for (var i = 0; i < v; i++) {
          ctx.drawImage(treeImage, i * d0, 0)
          ctx.drawImage(treeImage, i * d0, h - d0)
        }
        for (var j = 1; j < r; j++) {
          ctx.drawImage(treeImage, 0, j * d0)
          ctx.drawImage(treeImage, w - d0, j * d0)
        }

      }
      // Update game objects
      function update () {
        if (38 in keysDown) { // Player holding up
          if (hero.y > 0)
            hero.y -= hero.speed
          if (hero.y < d0) //can not go through trees!
            hero.y = d0
        }
        if (40 in keysDown) { // Player holding down
          if (hero.y < h - d0 - hero.sprite.height)
            hero.y += hero.speed
          if (hero.y > h - d0 - hero.sprite.height)
            hero.y = h - d0 - hero.sprite.height
        }
        if (37 in keysDown) { // Player holding left
          if (hero.x > 0)
            hero.x -= hero.speed
          if (hero.x < d0)
            hero.x = d0
        }
        if (39 in keysDown) { // Player holding right
          if (hero.x < w - d0 - hero.sprite.width)
            hero.x += hero.speed
          if (hero.x > w - d0 - hero.sprite.width)
            hero.x = w - d0 - hero.sprite.width
        }

        // Are they touching?
        if (collision(hero, seen)) {
          ++collected
          reset()
        }
      }
      function collision (obj1, obj2) {

        return obj2.x <= (obj1.x + obj1.sprite.width) &&
          obj1.x <= (obj2.x + obj2.sprite.width) &&
          obj2.y <= (obj1.y + obj1.sprite.height) &&
          obj1.y <= (obj2.y + obj2.sprite.height)

      }
      // Draw everything
      function render () {
        ctx.clearRect(0, 0, w, h)
        drawTrees()
        ctx.drawImage(hero.sprite, hero.x, hero.y)
        ctx.drawImage(seen.sprite, seen.x, seen.y)
        showScore('Seeni: ' + collected)
      }
      function showScore (txt) {
        // Score
        ctx.fillStyle = 'rgb(30, 10, 0)'
        ctx.font = '14px Arial'
        ctx.textAlign = 'left'
        ctx.textBaseline = 'top'
        ctx.strokeText(txt, d0, d0) //text, x,y
      }
      var reset = function () {
        //Put hero to the center
        hero.x = w / 2
        hero.y = h / 2
        // Throw the mushroom somewhere on the screen randomly
        do {
          seen.x = seen.sprite.width + (Math.random() * (w - 2 * seen.sprite.width))
          seen.y = seen.sprite.height + (Math.random() * (h - 2 * seen.sprite.height))
        } while (collision(seen, hero))
      }

      // The main game loop
      var game = function () {
        //var now = Date.now();
        //var delta = now - then;
        if (collected < seeni) {
          update()
          render()
          //then = now;
          setTimeout(game, 1000 / 60)  //millisekundid - 60 kaadrit sekundis
        }
        else {
          //ctx.fillStyle = '#AAEECC';
          //ctx.fillRect(d0,d0,w-2*d0,d0);
          var time = Math.round(((Date.now() - startTime) / 1000))
          showScore('Said ' + time + ' sekundiga ' + collected + ' seent!')
        }
      }
    </script>
</head>
<body>
<canvas id="gamecanvas" width="500" height="600"></canvas>
</body>
</html>